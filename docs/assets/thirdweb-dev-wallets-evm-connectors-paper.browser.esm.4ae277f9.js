import{a$ as Q,b0 as x,b1 as H,aH as F,aI as u,aQ as V,aJ as C,aL as m,aK as y,aT as $,aR as K}from"./index.58457bc4.js";import{n as J}from"./normalizeChainId-e4cc0175.browser.esm.042707b7.js";var B={Ethereum:"https://ethereum.rpc.thirdweb.com",Goerli:"https://goerli.rpc.thirdweb.com",Mumbai:"https://mumbai.rpc.thirdweb.com",Polygon:"https://polygon.rpc.thirdweb.com",Avalanche:"https://avalanche.rpc.thirdweb.com",Optimism:"https://optimism.rpc.thirdweb.com",OptimismGoerli:"https://optimism-goerli.rpc.thirdweb.com",BSC:"https://binance.rpc.thirdweb.com",BSCTestnet:"https://binance-testnet.rpc.thirdweb.com",ArbitrumOne:"https://arbitrum.rpc.thirdweb.com",ArbitrumGoerli:"https://arbitrum-goerli.rpc.thirdweb.com",Fantom:"https://fantom.rpc.thirdweb.com",FantomTestnet:"https://fantom-testnet.rpc.thirdweb.com",Sepolia:"https://sepolia.rpc.thirdweb.com",AvalancheFuji:"https://avalanche-fuji.rpc.thirdweb.com"},Z=()=>typeof window<"u"&&window.localStorage.getItem("IS_PAPER_DEV")==="true",X=()=>typeof window<"u"&&window.location.origin.includes("paper.xyz"),I=()=>{var e;return Z()?(e=window.localStorage.getItem("PAPER_DEV_URL"))!=null?e:"http://localhost:3000":X()?window.location.origin:"https://withpaper.com"},Y=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptors,M=Object.getOwnPropertySymbols,ie=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,W=(e,t,i)=>t in e?Y(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,g=(e,t)=>{for(var i in t||(t={}))ie.call(t,i)&&W(e,i,t[i]);if(M)for(var i of M(t))re.call(t,i)&&W(e,i,t[i]);return e},b=(e,t)=>ee(e,te(t)),a=(e,t,i)=>new Promise((r,n)=>{var s=l=>{try{c(i.next(l))}catch(d){n(d)}},o=l=>{try{c(i.throw(l))}catch(d){n(d)}},c=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);c((i=i.apply(e,t)).next())}),_="/sdk/2022-08-12/embedded-wallet",ne=e=>`paperEwsWalletUserDetails-${e}`,f=e=>`paperEwsWalletUserId-${e}`,ae="walletToken",L=e=>`${ae}-${e}`,U="a",A=(e,t)=>`${U}-${e}-${t}`,se=e=>`${U}-${e}`,R=(e=>(e.USER_MANAGED="USER_MANAGED",e.AWS_MANAGED="AWS_MANAGED",e))(R||{}),G=(e=>(e.PAPER_EMAIL_OTP="PaperEmailOTP",e.GOOGLE="Google",e.TWITTER="Twitter",e.COGNITO="Cognito",e.AUTH0="Auth0",e.CUSTOM_JWT="CustomJWT",e))(G||{}),w=(e=>(e.LOGGED_OUT="Logged Out",e.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",e))(w||{}),k=(e=>(e.LOGGED_OUT="Logged Out",e.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",e.LOGGED_IN_NEW_DEVICE="Logged In, New Device",e.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",e))(k||{}),N=new Map,O=class{constructor({clientId:e}){this.isSupported=typeof window<"u"&&!!window.localStorage,this.clientId=e}getItem(e){return a(this,null,function*(){var t;return this.isSupported?window.localStorage.getItem(e):(t=N.get(e))!=null?t:null})}setItem(e,t){return a(this,null,function*(){if(this.isSupported)return window.localStorage.setItem(e,t);N.set(e,t)})}removeItem(e){return a(this,null,function*(){let t=yield this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1})}saveAuthCookie(e){return a(this,null,function*(){yield this.setItem(L(this.clientId),e)})}getAuthCookie(){return a(this,null,function*(){return this.getItem(L(this.clientId))})}removeAuthCookie(){return a(this,null,function*(){return this.removeItem(L(this.clientId))})}saveDeviceShare(e,t){return a(this,null,function*(){yield this.saveWalletUserId(t),yield this.setItem(A(this.clientId,t),e)})}getDeviceShare(){return a(this,null,function*(){let e=yield this.getWalletUserId();return e?this.getItem(A(this.clientId,e)):null})}removeDeviceShare(){return a(this,null,function*(){let e=yield this.getWalletUserId();return e?this.removeItem(A(this.clientId,e)):!1})}getWalletUserId(){return a(this,null,function*(){return this.getItem(f(this.clientId))})}saveWalletUserId(e){return a(this,null,function*(){yield this.setItem(f(this.clientId),e)})}removeWalletUserId(){return a(this,null,function*(){return this.removeItem(f(this.clientId))})}};function E(e){return new Promise(t=>{setTimeout(t,e*1e3)})}var oe={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},S=new Map,le=class{constructor({link:e,iframeId:t,container:i=document.body,iframeStyles:r,onIframeInitialize:n}){this.POLLING_INTERVAL_SECONDS=1.4,this.POST_LOAD_BUFFER_SECONDS=1;let s=document.getElementById(t),o=new URL(e),c="1.1.3";if(o.searchParams.set("sdkVersion",c),!s||s.src!=o.href){if(!s){s=document.createElement("iframe");let l=g(g({},oe),r);Object.assign(s.style,l),s.setAttribute("id",t),s.setAttribute("fetchpriority","high"),i.appendChild(s)}s.src=o.href,s.setAttribute("data-version",c),s.onload=this.onIframeLoadHandler(s,this.POST_LOAD_BUFFER_SECONDS,n)}this.iframe=s}onIframeLoadedInitVariables(){return a(this,null,function*(){return{}})}onIframeLoadHandler(e,t,i){return()=>a(this,null,function*(){yield new Promise((r,n)=>a(this,null,function*(){var s;let o=new MessageChannel;o.port1.onmessage=l=>{let{data:d}=l;return o.port1.close(),d.success?(S.set(e.src,!0),i&&i(),r(!0)):n(new Error(d.error))},yield E(t);let c="initIframe";(s=e==null?void 0:e.contentWindow)==null||s.postMessage({eventType:c,data:yield this.onIframeLoadedInitVariables()},`${I()}${_}`,[o.port2])}))})}call(e){return a(this,arguments,function*({procedureName:t,params:i,showIframe:r=!1,injectRecoveryCode:n={isInjectRecoveryCode:!1}}){for(;!S.get(this.iframe.src);)yield E(this.POLLING_INTERVAL_SECONDS);return r&&(this.iframe.style.display="block",yield E(.005)),new Promise((s,o)=>{var c;if(n.isInjectRecoveryCode){let d=h=>a(this,null,function*(){var D,P;if(h.origin!==I()||h.data.type!=="paper_getRecoveryCode"||typeof h.data.userWalletId!="string")return;let z=yield(D=n.getRecoveryCode)==null?void 0:D.call(n,h.data.userWalletId);(P=this.iframe.contentWindow)==null||P.postMessage({type:"paper_getRecoveryCode_response",recoveryCode:z},I()),window.removeEventListener("message",d)});window.addEventListener("message",d)}let l=new MessageChannel;l.port1.onmessage=d=>a(this,null,function*(){let{data:h}=d;l.port1.close(),r&&(yield E(.1),this.iframe.style.display="none"),h.success?s(h.data):o(new Error(h.error))}),(c=this.iframe.contentWindow)==null||c.postMessage({eventType:t,data:i},`${I()}${_}`,[l.port2])})})}destroy(){S.delete(this.iframe.src)}},ce=class extends le{constructor({clientId:e,customizationOptions:t}){super({iframeId:he,link:de({clientId:e,path:_,queryParams:t}).href,container:document.body}),this.clientId=e}onIframeLoadedInitVariables(){return a(this,null,function*(){let e=new O({clientId:this.clientId});return{authCookie:yield e.getAuthCookie(),deviceShareStored:yield e.getDeviceShare(),walletUserId:yield e.getWalletUserId(),clientId:this.clientId}})}};function de({clientId:e,path:t,queryParams:i}){var r;let n=new URL(t,I());if(i)for(let s of Object.keys(i))n.searchParams.set(s,((r=i[s])==null?void 0:r.toString())||"");return n.searchParams.set("clientId",e),n}var he="paper-embedded-wallet-iframe",j=class{constructor({querier:e,preLogin:t,postLogin:i}){this.LoginQuerier=e,this.preLogin=t,this.postLogin=i}sendPaperEmailLoginOtp(e){return a(this,arguments,function*({email:t,recoveryShareManagement:i}){yield this.preLogin();let{isNewUser:r,isNewDevice:n}=yield this.LoginQuerier.call({procedureName:"sendPaperEmailLoginOtp",params:{email:t,recoveryShareManagement:i}});return{isNewUser:r,isNewDevice:n}})}},ue=class extends j{loginWithPaperModal(){return a(this,null,function*(){yield this.preLogin();let e=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(e)})}loginWithPaperEmailOtp(e){return a(this,arguments,function*({email:t}){yield this.preLogin();let i=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:t,recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(i)})}verifyPaperEmailLoginOtp(e){return a(this,arguments,function*({email:t,otp:i}){let r=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:t,otp:i,recoveryShareManagement:"AWS_MANAGED"},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(r)})}},pe=class extends j{loginWithPaperModal(e){return a(this,null,function*(){yield this.preLogin();let t=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:void 0,showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0,getRecoveryCode:e==null?void 0:e.getRecoveryCode}});return this.postLogin(t)})}loginWithPaperEmailOtp(e){return a(this,arguments,function*({email:t,recoveryCode:i}){yield this.preLogin();let r=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:t,recoveryCode:i},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(r)})}verifyPaperEmailLoginOtp(e){return a(this,arguments,function*({email:t,otp:i,recoveryCode:r}){let n=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:t,otp:i,recoveryCode:r},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(n)})}},ge=class{constructor({clientId:e,advancedOptions:t,querier:i,onAuthSuccess:r}){var n;this.clientId=e,this.advancedOptions={recoveryShareManagement:(n=t==null?void 0:t.recoveryShareManagement)!=null?n:"AWS_MANAGED"},this.AuthQuerier=i,this.localStorage=new O({clientId:e}),this.onAuthSuccess=r,this.userManagedLogin=new pe({postLogin:s=>a(this,null,function*(){return this.postLogin(s)}),preLogin:()=>a(this,null,function*(){yield this.preLogin()}),querier:i}),this.awsManagedLogin=new ue({postLogin:s=>a(this,null,function*(){return this.postLogin(s)}),preLogin:()=>a(this,null,function*(){yield this.preLogin()}),querier:i})}preLogin(){return a(this,null,function*(){yield this.logout()})}postLogin(e){return a(this,arguments,function*({storedToken:t,walletDetails:i}){return t.shouldStoreCookieString&&(yield this.localStorage.saveAuthCookie(t.cookieString)),yield this.onAuthSuccess({storedToken:t,walletDetails:i})})}loginWithJwtAuth(e){return a(this,arguments,function*({token:t,authProvider:i,recoveryCode:r}){yield this.preLogin();let n=yield this.AuthQuerier.call({procedureName:"loginWithJwtAuthCallback",params:{token:t,authProvider:i,recoveryCode:r}});return this.postLogin(n)})}loginWithPaperModal(e){return a(this,null,function*(){return yield this.preLogin(),this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperModal():this.userManagedLogin.loginWithPaperModal(e)})}loginWithPaperEmailOtp(e){return a(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperEmailOtp({email:e.email}):this.userManagedLogin.loginWithPaperEmailOtp(e)})}sendPaperEmailLoginOtp(e){return a(this,arguments,function*({email:t}){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.sendPaperEmailLoginOtp({email:t,recoveryShareManagement:"AWS_MANAGED"}):this.userManagedLogin.sendPaperEmailLoginOtp({email:t})})}verifyPaperEmailLoginOtp(e){return a(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.verifyPaperEmailLoginOtp(e):this.userManagedLogin.verifyPaperEmailLoginOtp(e)})}logout(){return a(this,null,function*(){let{success:e}=yield this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=yield this.localStorage.removeAuthCookie(),i=yield this.localStorage.removeWalletUserId();return{success:e||t||i}})}},T=class{constructor({chain:e,clientId:t,querier:i}){this.chain=e,this.clientId=t,this.gaslessTransactionQuerier=i}callContract(e){return a(this,arguments,function*({contractAddress:t,methodArgs:i,methodInterface:r}){return yield this.gaslessTransactionQuerier.call({procedureName:"callContract",params:{chain:this.chain,contractAddress:t,method:{args:i,stub:r}}})})}},q=class extends Q{constructor({provider:e,clientId:t,querier:i}){var r;super(),this.DEFAULT_ETHEREUM_CHAIN_ID=5,this.clientId=t,this.querier=i,this.endpoint=(r=e.connection)==null?void 0:r.url,x(this,"provider",e)}getAddress(){return a(this,null,function*(){let{address:e}=yield this.querier.call({procedureName:"getAddress",params:void 0});return e})}signMessage(e){return a(this,null,function*(){var t,i,r,n;let s=yield(t=this.provider)==null?void 0:t.getNetwork();s&&s._defaultProvider;let{signedMessage:o}=yield this.querier.call({procedureName:"signMessage",params:{message:e,chainId:(n=(r=yield(i=this.provider)==null?void 0:i.getNetwork())==null?void 0:r.chainId)!=null?n:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return o})}signTransaction(e){return a(this,null,function*(){var t,i,r;let{signedTransaction:n}=yield this.querier.call({procedureName:"signTransaction",params:{transaction:e,chainId:(r=(i=yield(t=this.provider)==null?void 0:t.getNetwork())==null?void 0:i.chainId)!=null?r:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return n})}_signTypedData(e,t,i){return a(this,null,function*(){var r,n,s;let{signedTypedData:o}=yield this.querier.call({procedureName:"signTypedDataV4",params:{domain:e,types:t,message:i,chainId:(s=(n=yield(r=this.provider)==null?void 0:r.getNetwork())==null?void 0:n.chainId)!=null?s:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return o})}connect(e){return new q({clientId:this.clientId,provider:e,querier:this.querier})}},me=class{constructor({clientId:e,chain:t,querier:i}){this.clientId=e,this.chain=t,this.walletManagerQuerier=i,this.gasless=new T({chain:t,clientId:e,querier:i}),this.localStorage=new O({clientId:e})}postWalletSetUp(e){return a(this,arguments,function*({deviceShareStored:t,walletAddress:i,isIframeStorageEnabled:r,walletUserId:n}){return r||(yield this.localStorage.saveDeviceShare(t,n)),{walletAddress:i}})}getUserWalletStatus(){return a(this,null,function*(){let e=yield this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",user:b(g({},e.user),{wallet:this})}:e})}setChain(e){return a(this,arguments,function*({chain:t}){this.chain=t,this.gasless=new T({chain:t,clientId:this.clientId,querier:this.walletManagerQuerier})})}getEthersJsSigner(e){return a(this,null,function*(){var t;return new q({clientId:this.clientId,provider:H((t=e==null?void 0:e.rpcEndpoint)!=null?t:B[this.chain]),querier:this.walletManagerQuerier})})}},ve=class{constructor({clientId:e,chain:t,styles:i,advancedOptions:r}){this.clientId=e,this.querier=new ce({clientId:e,customizationOptions:i}),this.wallet=new me({clientId:e,chain:t,querier:this.querier}),this.auth=new ge({clientId:e,advancedOptions:g({recoveryShareManagement:"USER_MANAGED"},r!=null?r:{}),querier:this.querier,onAuthSuccess:n=>a(this,null,function*(){return yield this.wallet.postWalletSetUp(b(g({},n.walletDetails),{walletUserId:n.storedToken.authDetails.userWalletId})),{user:{status:"Logged In, Wallet Initialized",authDetails:n.storedToken.authDetails,wallet:this.wallet,walletAddress:n.walletDetails.walletAddress}}})})}getUser(){return a(this,null,function*(){let e=yield this.wallet.getUserWalletStatus();switch(e.status){case"Logged In, New Device":case"Logged In, Wallet Uninitialized":return yield this.auth.logout(),this.getUser();case"Logged Out":return{status:"Logged Out"};case"Logged In, Wallet Initialized":return g({status:"Logged In, Wallet Initialized"},e.user)}})}};const Ie=Object.freeze(Object.defineProperty({__proto__:null,AUTH_TOKEN_LOCAL_STORAGE_NAME:L,AuthProvider:G,DEVICE_SHARE_LOCAL_STORAGE_NAME:A,DEVICE_SHARE_LOCAL_STORAGE_NAME_DEPRECATED:se,PaperEmbeddedWalletSdk:ve,RecoveryShareManagement:R,UserStatus:w,UserWalletStatus:k,WALLET_USER_DETAILS_LOCAL_STORAGE_NAME:ne,WALLET_USER_ID_LOCAL_STORAGE_NAME:f},Symbol.toStringTag,{value:"Module"}));var v=new WeakMap,p=new WeakMap;class Ee extends F{constructor(t){super(),u(this,"id",V.paper),u(this,"name","Paper Wallet"),u(this,"ready",!0),u(this,"user",null),C(this,v,{writable:!0,value:void 0}),C(this,p,{writable:!0,value:void 0}),u(this,"onAccountsChanged",async i=>{i.length===0?await this.onDisconnect():this.emit("change",{account:K(i[0])})}),u(this,"onChainChanged",i=>{const r=J(i),n=this.options.chains.findIndex(s=>s.chainId===r)===-1;this.emit("change",{chain:{id:r,unsupported:n}})}),u(this,"onDisconnect",async()=>{this.emit("disconnect")}),this.options=t}getPaperSDK(){return m(this,v)||y(this,v,new Promise(async(t,i)=>{var r;try{const{PaperEmbeddedWalletSdk:n}=await $(()=>Promise.resolve().then(()=>Ie),void 0);t(new n({advancedOptions:{recoveryShareManagement:(r=this.options.advancedOptions)==null?void 0:r.recoveryShareManagement},clientId:this.options.clientId,chain:"Ethereum",styles:this.options.styles}))}catch(n){i(n)}})),m(this,v)}async connect(t){const i=await this.getPaperSDK();if(!i)throw new Error("Paper SDK not initialized");const r=await i.getUser();switch(r.status){case w.LOGGED_OUT:{let n;t!=null&&t.email?n=await i.auth.loginWithPaperEmailOtp({email:t.email}):n=await i.auth.loginWithPaperModal(),this.user=n.user;break}case w.LOGGED_IN_WALLET_INITIALIZED:{this.user=r;break}}if(!this.user)throw new Error("Error connecting User");return t!=null&&t.chainId&&this.switchChain(t.chainId),this.setupListeners(),this.getAddress()}async disconnect(){const t=await m(this,v);await(t==null?void 0:t.auth.logout()),y(this,p,void 0),this.user=null}async getAddress(){return(await this.getSigner()).getAddress()}async isConnected(){try{return!!await this.getAddress()}catch{return!1}}async getProvider(){const t=await this.getSigner();if(!t.provider)throw new Error("Provider not found");return t.provider}async getSigner(){var i;if(m(this,p))return m(this,p);if(!this.user){const n=await(await this.getPaperSDK()).getUser();switch(n.status){case w.LOGGED_IN_WALLET_INITIALIZED:{this.user=n;break}}}const t=await((i=this.user)==null?void 0:i.wallet.getEthersJsSigner({rpcEndpoint:this.options.chain.rpc[0]}));if(!t)throw new Error("Signer not found");return y(this,p,t),t}async isAuthorized(){return!1}async switchChain(t){var r,n;const i=this.options.chains.find(s=>s.chainId===t);if(!i)throw new Error("Chain not configured");await((r=this.user)==null?void 0:r.wallet.setChain({chain:"Ethereum"})),y(this,p,await((n=this.user)==null?void 0:n.wallet.getEthersJsSigner({rpcEndpoint:i.rpc[0]}))),this.emit("change",{chain:{id:t,unsupported:!1}})}async setupListeners(){const t=await this.getProvider();t.on&&(t.on("accountsChanged",this.onAccountsChanged),t.on("chainChanged",this.onChainChanged),t.on("disconnect",this.onDisconnect))}updateChains(t){this.options.chains=t}async getEmail(){if(await this.getProvider(),!this.user)throw new Error("No user found, Paper Wallet is not connected");return this.user.authDetails.email}}export{Ee as PaperWalletConnector};
